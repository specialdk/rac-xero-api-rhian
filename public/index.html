<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC MCP - Integrated Dashboard with Enhanced Chat Filtering</title>

    <!-- Import shared styles -->
    <link rel="stylesheet" href="shared-styles.css" />

    <style>
      /* ====== PAGE-SPECIFIC STYLES ONLY ====== */
      /* Only styles unique to this page that aren't in shared-styles.css */

      /* Dashboard-specific grid override */
      .dashboard-grid {
        grid-template-columns: repeat(5, minmax(200px, 1fr)) !important;
        gap: 10px;
      }

      /* Enhanced company filter styling specific to dashboard */
      .company-filter-bar {
        background: #ecf0f1;
        padding: 12px 20px;
        border-bottom: 1px solid #bdc3c7;
        font-size: 13px;
      }

      .company-filter-bar .filter-label {
        display: inline-block;
        margin-right: 15px;
        font-weight: 600;
        color: #2c3e50;
      }

      .company-checkboxes {
        display: inline-flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      /* Quick filter buttons specific to dashboard */
      .quick-filter-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      .quick-filter-btn {
        padding: 4px 8px;
        border: 1px solid #bdc3c7;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        transition: all 0.2s;
      }

      .quick-filter-btn:hover {
        background: #3498db;
        color: white;
        border-color: #3498db;
      }

      /* Analysis status boxes for dashboard */
      .company-analysis-status {
        background: #e8f4f8;
        border: 1px solid #bee5eb;
        border-radius: 4px;
        padding: 8px 12px;
        margin: 8px 0;
        font-size: 12px;
        color: #0c5460;
      }

      .filter-summary {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        padding: 8px 12px;
        margin-top: 8px;
        font-size: 12px;
        color: #856404;
      }

      /* YoY status indicator */
      .yoy-status {
        font-size: 11px;
        margin-left: 5px;
        color: #999;
      }

      /* Dashboard-specific header styling */
      .individual-company-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-bottom: 20px;
      }

      .consolidated-header {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
        margin-bottom: 20px;
      }

      /* Company breakdown cards for dashboard */
      .company-breakdown {
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 15px;
        margin: 10px 0;
        background: #fafafa;
      }

      .company-breakdown.balanced {
        background: #f8fff8;
        border-color: #27ae60;
      }

      .company-breakdown.imbalanced {
        background: #fff8f8;
        border-color: #e74c3c;
      }

      /* Monthly performance grid for YoY analysis */
      .monthly-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin: 15px 0;
      }

      .monthly-card {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 12px;
        font-size: 12px;
        background: #fafafa;
      }

      .monthly-card.profitable {
        background: #f8fff8;
        border-color: #27ae60;
      }

      .monthly-card.loss {
        background: #fff8f8;
        border-color: #e74c3c;
      }

      /* Retry button for error states */
      .retry-btn {
        margin-top: 10px;
        padding: 8px 16px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      /* View mode indicator in header */
      .view-mode-indicator {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
        margin-left: 15px;
      }

      /* Unused chat panel styles - hidden but kept for potential future use */
      .ai-chat-panel {
        display: none;
      }

      .resizer {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- CONNECTION MANAGER SECTION -->
    <div class="connection-manager" id="connectionManager">
      <div class="login-container">
        <div class="login-header">
          <h1>RAC Multi-Company Login Manager</h1>
          <p>Streamlined access to your Xero organisations</p>
        </div>

        <div class="login-content">
          <!-- Step Indicator -->
          <div class="step-indicator">
            <div class="step active" id="step1Indicator">
              <div class="step-number">1</div>
              <span>Select Companies</span>
            </div>
            <div class="step" id="step2Indicator">
              <div class="step-number">2</div>
              <span>OAuth Authentication</span>
            </div>
            <div class="step" id="step3Indicator">
              <div class="step-number">3</div>
              <span>Launch Dashboard</span>
            </div>
          </div>

          <!-- Step 1: Company Selection -->
          <div class="company-selection" id="step1">
            <h2 style="text-align: center; margin-bottom: 1rem; color: #333">
              Select Companies to Connect
            </h2>

            <div class="company-list">
              <!-- ALL Companies Option -->
              <div
                class="company-item all-companies"
                onclick="toggleAllCompanies(event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="all-companies"
                />
                <div class="company-name">üöÄ ALL COMPANIES (Quick Connect)</div>
              </div>

              <!-- Individual Companies -->
              <div class="company-item" onclick="toggleCompany('rac', event)">
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-rac"
                />
                <div class="company-name">
                  Rirratjingu Aboriginal Corporation 8538
                </div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('mining', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-mining"
                />
                <div class="company-name">Rirratjingu Mining Pty Ltd 7168</div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('property', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-property"
                />
                <div class="company-name">
                  Rirratjingu Property Management & Maintenance Services Pty Ltd
                </div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('enterprises', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-enterprises"
                />
                <div class="company-name">Rirratjingu Enterprises Pty Ltd</div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('invest', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-invest"
                />
                <div class="company-name">
                  Rirratjingu Invest P/ L ATF Miliditjpi Trust
                </div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('ngarrkuwuy', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-ngarrkuwuy"
                />
                <div class="company-name">Ngarrkuwuy Developments Pty Ltd</div>
              </div>

              <div
                class="company-item"
                onclick="toggleCompany('marrin', event)"
              >
                <input
                  type="checkbox"
                  class="company-checkbox"
                  id="company-marrin"
                />
                <div class="company-name">
                  Marrin Square Developments Pty Ltd
                </div>
              </div>
            </div>

            <div class="selection-summary" id="selectionSummary">
              <strong>Selected: 0 companies</strong>
            </div>

            <button
              class="continue-btn"
              id="continueBtn"
              onclick="startOAuthFlow()"
              disabled
            >
              Continue with Selected Companies
            </button>
          </div>

          <!-- Step 2: OAuth Flow -->
          <div class="oauth-flow" id="step2">
            <h2>Connecting to Your Companies</h2>

            <div class="current-connection">
              <h3 id="currentCompanyName">Ready to connect...</h3>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  id="progressFill"
                  style="width: 0%"
                ></div>
              </div>
              <div id="progressText">Preparing connections...</div>
            </div>

            <div class="success-box" id="oauthInstructions">
              <strong>Ready to start:</strong> Click "Start OAuth Flow" to begin
              connecting to your selected companies.
            </div>

            <div id="oauthButtons">
              <button
                class="oauth-btn primary"
                onclick="startNextOAuth()"
                id="startOAuthBtn"
              >
                üîó Start OAuth Flow
              </button>
            </div>

            <div id="waitingMessage" style="display: none">
              <div class="success-box">
                <strong>Waiting for OAuth completion...</strong><br />
                Complete the Xero authorization, then return here.
              </div>
              <button class="oauth-btn" onclick="checkOAuthStatus()">
                ‚úÖ I've completed the OAuth - Continue
              </button>
            </div>
          </div>

          <!-- Step 3: Completion -->
          <div class="completion" id="step3">
            <h2>üéâ All Companies Connected!</h2>
            <div class="connected-companies" id="connectedCompaniesList"></div>
            <div class="success-box">
              <strong>Ready to launch!</strong> All selected companies are now
              connected.
            </div>
            <button class="launch-btn" onclick="showMainDashboard()">
              üöÄ Launch Financial Dashboard
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SINGLE PANEL DASHBOARD SECTION -->

    <div class="main-dashboard" id="mainDashboard">
      <div class="header">
        <h1>RAC Financial Dashboard</h1>
        <div class="session-info">
          Session: Active | Connected Companies:
          <span id="connectedCount">0</span>
          <button class="back-to-connections" onclick="backToConnections()">
            üîô Manage Connections
          </button>
        </div>
      </div>

      <div class="main-container">
        <div class="dashboard-panel">
          <div class="panel-header">
            <span class="status-indicator balanced" id="dashboardStatus"></span>
            Financial Dashboard - Live Data

            <!-- Simple company filter moved to header -->
            <div
              style="
                display: inline-flex;
                gap: 15px;
                margin-left: 30px;
                font-size: 13px;
              "
            >
              <span style="font-weight: 600">Companies:</span>
              <div id="companyFilters" style="display: inline-flex; gap: 10px">
                <!-- Company checkboxes will be populated here -->
              </div>
            </div>
          </div>

          <div class="dashboard-content">
            <div class="toolbar">
              <button class="active" onclick="setView('overview', this)">
                Overview
              </button>
              <button onclick="setView('trial-balance', this)">
                Trial Balance
              </button>
              <button onclick="setView('cash-flow', this)">Cash Flow</button>
              <button onclick="setView('p-and-l', this)">P&L</button>
              <button onclick="setView('year-over-year', this)" id="yoyButton">
                YoY Analysis<span id="yoyStatus" class="yoy-status">‚óè</span>
              </button>
              <button onclick="setView('alerts', this)">Alerts</button>
            </div>

            <div id="dashboardData">
              <div class="loading">
                <div class="loading-spinner"></div>
                Loading financial data from connected companies...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ====== GLOBAL VARIABLES ======
      const companies = {
        rac: "Rirratjingu Aboriginal Corporation 8538",
        mining: "Rirratjingu Mining Pty Ltd 7168",
        property:
          "Rirratjingu Property Management & Maintenance Services Pty Ltd",
        enterprises: "Rirratjingu Enterprises Pty Ltd",
        invest: "Rirratjingu Invest P/ L ATF Miliditjpi Trust",
      };

      let selectedCompanies = [];
      let oauthProgress = 0;
      let connectedCompanies = [];
      let isOAuthInProgress = false;
      let activeCompanyFilters = [];
      let currentView = "overview";

      // YoY caching variables
      let cachedYoYData = null;
      let yoyLoadingStartTime = null;

      // ====== OPTIMIZED UTILITY FUNCTIONS ======

      function getViewMode() {
        if (activeCompanyFilters.length === 0) return "none";
        return activeCompanyFilters.length === 1
          ? "individual"
          : "consolidated";
      }

      function updateViewModeIndicator() {
        const indicator = document.getElementById("viewModeIndicator");

        // Safety check - if element doesn't exist, skip this function
        if (!indicator) {
          console.log("viewModeIndicator element not found - skipping update");
          return;
        }

        const viewMode = getViewMode();
        const colors = {
          none: "#e74c3c",
          individual: "#667eea",
          consolidated: "#27ae60",
        };

        const messages = {
          none: "No companies selected",
          individual: `Individual: ${getSelectedCompanyNames()[0]}`,
          consolidated: `Consolidated: ${activeCompanyFilters.length} companies`,
        };

        indicator.textContent = messages[viewMode];
        indicator.style.color = colors[viewMode];
      }

      function getOrganizationName(tenantName) {
        const mapping = {
          Mining: "Mining",
          "Aboriginal Corporation": "Aboriginal Corporation",
          Property: "Property",
          Enterprises: "Enterprises",
          Invest: "Invest",
        };

        return Object.keys(mapping).find((key) => tenantName.includes(key))
          ? mapping[
              Object.keys(mapping).find((key) => tenantName.includes(key))
            ]
          : "Unknown";
      }

      function getSelectedCompanyNames() {
        return activeCompanyFilters.map((tenantId) => {
          const company = connectedCompanies.find(
            (c) => c.tenantId === tenantId
          );
          return company
            ? company.tenantName
                .replace("Rirratjingu ", "")
                .replace(" Pty Ltd", "")
            : "Unknown";
        });
      }

      function calculateGrowthRate(prior, current) {
        if (prior === 0 && current === 0) return 0;
        if (prior === 0) return current > 0 ? 100 : -100;
        return ((current - prior) / Math.abs(prior)) * 100;
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("en-AU", {
          style: "currency",
          currency: "AUD",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }).format(amount || 0);
      }

      function formatPercentage(value) {
        const sign = value > 0 ? "+" : "";
        return `${sign}${value.toFixed(1)}%`;
      }

      // ====== CONSOLIDATED DATA LOADING FUNCTION ======
      // This replaces multiple similar functions with one unified loader

      async function loadFinancialDataForSelectedCompanies(
        endpoint,
        params = {}
      ) {
        if (activeCompanyFilters.length === 0) return [];

        const loadingPromises = activeCompanyFilters.map(async (tenantId) => {
          try {
            const urlParams = new URLSearchParams({ ...params });
            const response = await fetch(
              `/api/${endpoint}/${tenantId}?${urlParams}`
            );

            if (!response.ok) {
              console.error(
                `Failed to load ${endpoint} for tenant ${tenantId}:`,
                response.statusText
              );
              return null;
            }

            const data = await response.json();
            return {
              tenantId,
              data,
              organizationName: getOrganizationName(tenantId),
            };
          } catch (error) {
            console.error(
              `Error loading ${endpoint} for tenant ${tenantId}:`,
              error
            );
            return null;
          }
        });

        const results = await Promise.all(loadingPromises);
        return results.filter((result) => result !== null);
      }

      // ====== UNIFIED RENDER FUNCTION ======
      // This replaces separate renderIndividual/renderConsolidated functions

      function renderFinancialView(viewType, dataArray) {
        const viewMode = getViewMode();
        if (viewMode === "none")
          return '<div class="no-data">No companies selected</div>';

        const renderFunctions = {
          "trial-balance":
            viewMode === "individual"
              ? renderIndividualTrialBalance
              : renderConsolidatedTrialBalance,
          "cash-flow":
            viewMode === "individual"
              ? renderIndividualCashFlow
              : renderConsolidatedCashFlow,
          "profit-loss":
            viewMode === "individual"
              ? renderIndividualProfitLoss
              : renderConsolidatedProfitLoss,
          overview:
            viewMode === "individual"
              ? renderIndividualOverview
              : renderConsolidatedOverview,
        };

        const renderFunction = renderFunctions[viewType];
        return renderFunction
          ? renderFunction(dataArray)
          : '<div class="error">Unknown view type</div>';
      }

      // ====== STREAMLINED VIEW SWITCHING ======

      function setView(view, buttonElement) {
        // Remove active class from all buttons
        document
          .querySelectorAll(".nav-button")
          .forEach((btn) => btn.classList.remove("active"));

        // Add active class to clicked button
        if (buttonElement) buttonElement.classList.add("active");

        currentView = view;
        loadDashboardData();
      }

      async function loadDashboardData() {
        if (activeCompanyFilters.length === 0) {
          document.getElementById("dashboardData").innerHTML =
            '<div class="no-data">Please select companies to view financial data</div>';
          return;
        }

        // Show loading
        document.getElementById("dashboardData").innerHTML =
          '<div class="loading"><div class="loading-spinner"></div>Loading financial data...</div>';

        try {
          let dataArray;

          switch (currentView) {
            case "trial-balance":
              dataArray = await loadFinancialDataForSelectedCompanies(
                "trial-balance"
              );
              document.getElementById("dashboardData").innerHTML =
                renderFinancialView("trial-balance", dataArray);
              break;

            case "cash-flow":
              dataArray = await loadFinancialDataForSelectedCompanies(
                "cash-position"
              );
              document.getElementById("dashboardData").innerHTML =
                renderFinancialView("cash-flow", dataArray);
              break;

            case "profit-loss":
              dataArray = await loadFinancialDataForSelectedCompanies(
                "profit-loss"
              );
              document.getElementById("dashboardData").innerHTML =
                renderFinancialView("profit-loss", dataArray);
              break;

            case "year-over-year":
              if (cachedYoYData) {
                renderYoYFromCachedData();
              } else {
                await loadYoYAnalysis();
              }
              break;

            case "alerts":
              await loadAlertsView();
              break;

            default: // overview
              await loadOverviewData();
              break;
          }
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          document.getElementById("dashboardData").innerHTML =
            '<div class="error">Error loading financial data. Please try again.</div>';
        }
      }

      // ====== OPTIMIZED ERROR HANDLING ======

      function handleApiError(error, context) {
        console.error(`Error in ${context}:`, error);
        return `<div class="error">Failed to load ${context}. Please try refreshing the page.</div>`;
      }

      // ====== YOY BACKGROUND LOADING OPTIMIZATION ======

      function startYoYBackgroundLoading() {
        if (!cachedYoYData && activeCompanyFilters.length > 0) {
          yoyLoadingStartTime = Date.now();
          updateYoYStatus("loading");
          loadYoYInBackground();
        }
      }

      async function loadYoYInBackground() {
        try {
          const promises = activeCompanyFilters.map(async (tenantId) => {
            const [currentYear, priorYear] = await Promise.all([
              fetch(`/api/profit-loss/${tenantId}?periodMonths=12`).then((r) =>
                r.json()
              ),
              fetch(
                `/api/profit-loss/${tenantId}?periodMonths=12&date=${getPriorYearDate()}`
              ).then((r) => r.json()),
            ]);

            return {
              tenantId,
              currentYear,
              priorYear,
              organizationName: getOrganizationName(tenantId),
            };
          });

          cachedYoYData = await Promise.all(promises);
          updateYoYStatus("loaded");
        } catch (error) {
          console.error("Background YoY loading failed:", error);
          updateYoYStatus("error");
        }
      }

      function updateYoYStatus(status) {
        const statusElement = document.getElementById("yoyStatus");
        const statusMap = {
          loading: { color: "#f39c12", text: "‚óè" },
          loaded: { color: "#27ae60", text: "‚óè" },
          error: { color: "#e74c3c", text: "‚óè" },
        };

        if (statusElement && statusMap[status]) {
          statusElement.style.color = statusMap[status].color;
          statusElement.textContent = statusMap[status].text;
        }
      }

      function getPriorYearDate() {
        const date = new Date();
        date.setFullYear(date.getFullYear() - 1);
        return date.toISOString().split("T")[0];
      }

      // ====== COMPANY FILTER OPTIMIZATION ======

      function toggleCompany(tenantId, companyName) {
        const index = activeCompanyFilters.indexOf(tenantId);

        if (index === -1) {
          activeCompanyFilters.push(tenantId);
        } else {
          activeCompanyFilters.splice(index, 1);
        }

        updateFilterButtons();
        updateViewModeIndicator();

        // Auto-refresh current view
        if (currentView) loadDashboardData();

        // Start YoY background loading for new selections
        startYoYBackgroundLoading();
      }

      function updateFilterButtons() {
        connectedCompanies.forEach((company) => {
          const button = document.querySelector(
            `[data-tenant-id="${company.tenantId}"]`
          );
          if (button) {
            button.classList.toggle(
              "active",
              activeCompanyFilters.includes(company.tenantId)
            );
          }
        });
      }

      // ====== INITIALIZATION ======

      function initializeMainDashboard() {
        loadConnectedCompanies();
        setView("overview", document.querySelector(".nav-button"));
      }

      async function loadConnectedCompanies() {
        try {
          const response = await fetch("/api/connected-companies");
          if (response.ok) {
            connectedCompanies = await response.json();
            renderCompanyFilters();
            updateConnectedCount();
          }
        } catch (error) {
          console.error("Error loading companies:", error);
        }
      }

      function renderCompanyFilters() {
        const container = document.getElementById("companyFilters");
        container.innerHTML = connectedCompanies
          .map((company) => {
            const shortName = company.tenantName
              .replace("Rirratjingu ", "")
              .replace(" Pty Ltd", "");
            return `
      <button class="filter-button" 
              data-tenant-id="${company.tenantId}" 
              onclick="toggleCompany('${company.tenantId}', '${shortName}')">
        ${shortName}
      </button>`;
          })
          .join("");
      }

      function updateConnectedCount() {
        document.getElementById("connectedCount").textContent =
          connectedCompanies.length;
      }

      // ====== CONNECTION MANAGER FUNCTIONS ======

      function loadSavedPreferences() {
        const saved = localStorage.getItem("racCompanyPreferences");
        if (saved) {
          try {
            selectedCompanies = JSON.parse(saved);
            selectedCompanies.forEach((companyId) => {
              const checkbox = document.getElementById(`company-${companyId}`);
              if (checkbox) checkbox.checked = true;
            });
            updateSelectionSummary();
          } catch (error) {
            console.log("No valid saved preferences");
          }
        }
      }

      function savePreferences() {
        localStorage.setItem(
          "racCompanyPreferences",
          JSON.stringify(selectedCompanies)
        );
      }

      function toggleAllCompanies(event) {
        event.stopPropagation();
        const allCheckbox = document.getElementById("all-companies");
        allCheckbox.checked = !allCheckbox.checked;

        if (allCheckbox.checked) {
          selectedCompanies = Object.keys(companies);
          Object.keys(companies).forEach((companyId) => {
            document.getElementById(`company-${companyId}`).checked = true;
          });
        } else {
          selectedCompanies = [];
          Object.keys(companies).forEach((companyId) => {
            document.getElementById(`company-${companyId}`).checked = false;
          });
        }

        updateSelectionSummary();
        savePreferences();
      }

      function updateSelectionSummary() {
        const summary = document.getElementById("selectionSummary");
        const continueBtn = document.getElementById("continueBtn");

        summary.innerHTML = `<strong>Selected: ${selectedCompanies.length} companies</strong>`;

        if (selectedCompanies.length > 0) {
          const companyNames = selectedCompanies.map((id) => companies[id]);
          summary.innerHTML += `<br><small>${companyNames.join(", ")}</small>`;
          continueBtn.disabled = false;
        } else {
          continueBtn.disabled = true;
        }
      }

      function startOAuthFlow() {
        if (selectedCompanies.length === 0) {
          alert("Please select at least one company to continue.");
          return;
        }

        document.getElementById("step1").style.display = "none";
        document.getElementById("step2").style.display = "block";
        document.getElementById("step1Indicator").classList.add("completed");
        document.getElementById("step1Indicator").classList.remove("active");
        document.getElementById("step2Indicator").classList.add("active");

        oauthProgress = 0;
        connectedCompanies = [];
        localStorage.setItem(
          "oauthCompanies",
          JSON.stringify(selectedCompanies)
        );
        localStorage.setItem("oauthProgress", "0");
        updateOAuthProgress();
      }

      function updateOAuthProgress() {
        const currentCompanyName =
          document.getElementById("currentCompanyName");
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");

        if (oauthProgress < selectedCompanies.length) {
          const companyId = selectedCompanies[oauthProgress];
          const companyName = companies[companyId];

          currentCompanyName.textContent = `Ready to connect: ${companyName} (${
            oauthProgress + 1
          }/${selectedCompanies.length})`;
          const progressPercent =
            (oauthProgress / selectedCompanies.length) * 100;
          progressFill.style.width = progressPercent + "%";
          progressText.textContent = `Step ${oauthProgress + 1} of ${
            selectedCompanies.length
          }`;

          document.getElementById("oauthInstructions").innerHTML = `
            <strong>Next Company:</strong> ${companyName}<br>
            <small>When the Xero login opens, select "${companyName}" from the dropdown and authorize access.</small>
          `;
        }
      }

      function startNextOAuth() {
        if (oauthProgress >= selectedCompanies.length) {
          showCompletion();
          return;
        }

        const companyId = selectedCompanies[oauthProgress];
        const companyName = companies[companyId];

        localStorage.setItem("currentOAuthCompany", companyId);
        localStorage.setItem("currentOAuthCompanyName", companyName);

        isOAuthInProgress = true;
        document.getElementById("startOAuthBtn").style.display = "none";
        document.getElementById("waitingMessage").style.display = "block";

        window.location.href = "/auth";
      }

      async function checkOAuthStatus() {
        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();

          const currentCompanyName = localStorage.getItem(
            "currentOAuthCompanyName"
          );
          const currentCompanyId = localStorage.getItem("currentOAuthCompany");

          const newConnection = connections.find(
            (conn) => conn.tenantName === currentCompanyName && conn.connected
          );

          if (newConnection) {
            connectedCompanies.push({
              id: currentCompanyId,
              name: currentCompanyName,
              tenantId: newConnection.tenantId,
            });

            oauthProgress++;
            localStorage.setItem("oauthProgress", oauthProgress.toString());

            isOAuthInProgress = false;
            document.getElementById("startOAuthBtn").style.display =
              "inline-block";
            document.getElementById("waitingMessage").style.display = "none";

            if (oauthProgress < selectedCompanies.length) {
              updateOAuthProgress();
              document.getElementById(
                "startOAuthBtn"
              ).textContent = `üîó Connect Next Company (${oauthProgress + 1}/${
                selectedCompanies.length
              })`;
            } else {
              showCompletion();
            }
          } else {
            alert(
              `‚ö† Failed to connect ${currentCompanyName}. Please try again.`
            );
            isOAuthInProgress = false;
            document.getElementById("startOAuthBtn").style.display =
              "inline-block";
            document.getElementById("waitingMessage").style.display = "none";
          }
        } catch (error) {
          console.error("‚ö† Error checking OAuth status:", error);
          alert("‚ö† Error checking connection status. Please try again.");
          isOAuthInProgress = false;
          document.getElementById("startOAuthBtn").style.display =
            "inline-block";
          document.getElementById("waitingMessage").style.display = "none";
        }
      }

      function showCompletion() {
        document.getElementById("step2").style.display = "none";
        document.getElementById("step3").style.display = "block";
        document.getElementById("step2Indicator").classList.add("completed");
        document.getElementById("step2Indicator").classList.remove("active");
        document.getElementById("step3Indicator").classList.add("active");

        const connectedList = document.getElementById("connectedCompaniesList");
        connectedList.innerHTML = connectedCompanies
          .map(
            (company) => `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid #28a745; background: #f8fff9; border-radius: 6px; margin-bottom: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 12px; height: 12px; border-radius: 50%; background: #28a745;"></div>
              <strong>${company.name}</strong>
            </div>
            <div style="color: #28a745; font-size: 0.9rem;">‚úÖ Connected</div>
          </div>
        `
          )
          .join("");

        setTimeout(() => showMainDashboard(), 3000);
      }

      function showMainDashboard() {
        localStorage.removeItem("oauthCompanies");
        localStorage.removeItem("oauthProgress");
        localStorage.removeItem("currentOAuthCompany");
        localStorage.removeItem("currentOAuthCompanyName");
        localStorage.setItem("racCompaniesConnected", "true");

        document.getElementById("connectionManager").style.display = "none";
        document.getElementById("mainDashboard").style.display = "block";

        initializeMainDashboard();
      }

      function handleOAuthReturn() {
        const urlParams = new URLSearchParams(window.location.search);
        const isSuccess = urlParams.has("success");
        const isError = urlParams.has("error");
        const oauthCompanies = localStorage.getItem("oauthCompanies");

        if (isSuccess && oauthCompanies) {
          selectedCompanies = JSON.parse(oauthCompanies);
          oauthProgress = parseInt(localStorage.getItem("oauthProgress")) || 0;

          document.getElementById("connectionManager").style.display = "block";
          document.getElementById("mainDashboard").style.display = "none";
          document.getElementById("step1").style.display = "none";
          document.getElementById("step2").style.display = "block";
          document.getElementById("step1Indicator").classList.add("completed");
          document.getElementById("step2Indicator").classList.add("active");

          setTimeout(() => checkOAuthStatus(), 1000);
        }

        if (isSuccess || isError) {
          history.replaceState({}, document.title, window.location.pathname);
        }
      }

      // ====== DASHBOARD FUNCTIONS ======

      function setupCompanyFilters() {
        const filtersContainer = document.getElementById("companyFilters");

        if (connectedCompanies.length === 0) {
          filtersContainer.innerHTML =
            '<div style="color: #e74c3c;">No companies connected</div>';
          return;
        }

        filtersContainer.innerHTML = connectedCompanies
          .map((company) => {
            const shortName = company.tenantName
              .replace("Rirratjingu ", "")
              .replace(" Pty Ltd", "");
            return `
            <div class="company-checkbox-item balanced">
              <input type="checkbox" id="filter-${company.tenantId}" checked 
                     onchange="handleCompanyFilterChange('${company.tenantId}')">
              <label for="filter-${company.tenantId}" 
                     onclick="toggleCompanyFilterByLabel('${company.tenantId}')">${shortName}</label>
            </div>
          `;
          })
          .join("");
      }

      function handleCompanyFilterChange(tenantId) {
        const checkbox = document.getElementById(`filter-${tenantId}`);

        if (checkbox.checked) {
          if (!activeCompanyFilters.includes(tenantId)) {
            activeCompanyFilters.push(tenantId);
          }
        } else {
          activeCompanyFilters = activeCompanyFilters.filter(
            (id) => id !== tenantId
          );
        }

        loadDashboardData();
        const selectedCompanies = getSelectedCompanyNames();
      }

      function toggleCompanyFilterByLabel(tenantId) {
        const checkbox = document.getElementById(`filter-${tenantId}`);
        checkbox.checked = !checkbox.checked;

        const event = new Event("change");
        checkbox.dispatchEvent(event);
      }

      // Helper functions and data loading methods would continue here...
      // (Rest of JavaScript implementation - keeping for brevity)

      // Add this function to your JavaScript - it got lost during reorganization

      async function loadOverviewData() {
        try {
          const dataArray = await loadFinancialDataForSelectedCompanies(
            "trial-balance"
          );

          if (dataArray.length === 0) {
            document.getElementById("dashboardData").innerHTML =
              '<div class="no-data">No company data available</div>';
            return;
          }

          const viewMode = getViewMode();
          let overviewHtml = "";

          if (viewMode === "individual") {
            overviewHtml = renderIndividualOverview(dataArray[0]);
          } else {
            overviewHtml = renderConsolidatedOverview(dataArray);
          }

          document.getElementById("dashboardData").innerHTML = overviewHtml;
        } catch (error) {
          console.error("Error loading overview data:", error);
          document.getElementById("dashboardData").innerHTML =
            '<div class="error">Error loading overview data. Please try again.</div>';
        }
      }

      // Also add this missing function for alerts
      async function loadAlertsView() {
        document.getElementById("dashboardData").innerHTML = `
    <div class="dashboard-card">
      <h3>System Alerts</h3>
      <div class="alert-item">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <span>No critical alerts at this time</span>
      </div>
    </div>
  `;
      }

      // Placeholder implementations for brevity - include all your dashboard functions here
      async function loadOverviewDataWithYoY() {
        // Check if any companies are selected
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
                  <div style="text-align: center; padding: 40px; color: #666;">
                    <h3>No Companies Selected</h3>
                    <p>Please select companies using the filters above to view financial data.</p>
                  </div>
                `;
          return;
        }

        try {
          // Load consolidated data + enhanced metrics for selected companies
          const response = await fetch("/api/consolidated-trial-balance");
          const data = await response.json();

          // Enhanced matching logic (keeping the good parts from before)
          const selectedCompanies = [];
          const enhancedMetrics = [];

          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            // Find matching company data
            let matchedCompany = data.companies?.find(
              (company) => company.tenantId === tenantId
            );

            if (!matchedCompany) {
              matchedCompany = data.companies?.find((company) => {
                const companyName = company.tenantName.toLowerCase();
                const targetName = connectedCompany.tenantName.toLowerCase();
                return (
                  (companyName.includes("mining") &&
                    targetName.includes("mining")) ||
                  (companyName.includes("aboriginal") &&
                    targetName.includes("aboriginal")) ||
                  (companyName.includes("property") &&
                    targetName.includes("property"))
                );
              });
            }

            if (matchedCompany) {
              selectedCompanies.push(matchedCompany);

              // Load enhanced metrics for each selected company
              try {
                const orgName = getOrganizationName(
                  connectedCompany.tenantName
                );

                // Fetch multiple data sources in parallel
                const [cashResponse, ratiosResponse, profitLossResponse] =
                  await Promise.all([
                    fetch("/api/cash-position", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ organizationName: orgName }),
                    }).catch(() => null),

                    fetch("/api/financial-ratios", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ organizationName: orgName }),
                    }).catch(() => null),

                    fetch("/api/profit-loss-summary", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ organizationName: orgName }),
                    }).catch(() => null),
                  ]);

                // Read response text once and store it
                // Read response JSON once and store it with debugging
                let cashData = null,
                  ratiosData = null,
                  profitLossData = null;

                if (cashResponse) {
                  if (cashResponse.ok) {
                    cashData = await cashResponse.json();
                    console.log("Cash data for", orgName, ":", cashData);
                  } else {
                    console.error(
                      "Cash API error for",
                      orgName,
                      ":",
                      cashResponse.status,
                      await cashResponse.text()
                    );
                  }
                }

                if (ratiosResponse) {
                  if (ratiosResponse.ok) {
                    ratiosData = await ratiosResponse.json();
                    console.log("Ratios data for", orgName, ":", ratiosData);
                  } else {
                    console.error(
                      "Ratios API error for",
                      orgName,
                      ":",
                      ratiosResponse.status,
                      await ratiosResponse.text()
                    );
                  }
                }

                if (profitLossResponse) {
                  if (profitLossResponse.ok) {
                    profitLossData = await profitLossResponse.json();
                    console.log("P&L data for", orgName, ":", profitLossData);
                  } else {
                    console.error(
                      "P&L API error for",
                      orgName,
                      ":",
                      profitLossResponse.status,
                      await profitLossResponse.text()
                    );
                  }
                }

                // Parse enhanced metrics using stored text
                // Extract from JSON responses
                const enhancedData = {
                  tenantId: tenantId,
                  companyName: connectedCompany.tenantName,

                  // Basic financials from trial balance
                  totalAssets: matchedCompany.totals?.totalAssets || 0,
                  totalLiabilities: Math.abs(
                    matchedCompany.totals?.totalLiabilities || 0
                  ),
                  totalEquity: matchedCompany.totals?.totalEquity || 0,
                  balanced:
                    matchedCompany.balanceCheck?.debitsEqualCredits || false,

                  // Enhanced metrics from API responses
                  cashPosition: cashData?.totalCash || 0,
                  currentRatio:
                    ratiosData?.ratios?.liquidity?.currentRatio || 0,
                  debtToEquity: ratiosData?.ratios?.leverage?.debtToEquity || 0,
                  netProfitMargin:
                    ratiosData?.ratios?.profitability?.netProfitMargin || 0,
                  returnOnAssets:
                    ratiosData?.ratios?.profitability?.returnOnAssets || 0,
                  revenue: profitLossData?.summary?.totalRevenue || 0,
                  netProfit: profitLossData?.summary?.netProfit || 0,
                };
                enhancedMetrics.push(enhancedData);
              } catch (error) {
                console.error(
                  `Error loading enhanced metrics for ${connectedCompany.tenantName}:`,
                  error
                );
                enhancedMetrics.push({
                  tenantId: tenantId,
                  companyName: connectedCompany.tenantName,
                  totalAssets: matchedCompany.totals?.totalAssets || 0,
                  totalLiabilities: Math.abs(
                    matchedCompany.totals?.totalLiabilities || 0
                  ),
                  totalEquity: matchedCompany.totals?.totalEquity || 0,
                  balanced:
                    matchedCompany.balanceCheck?.debitsEqualCredits || false,
                  error: true,
                });
              }
            }
          }

          // Calculate consolidated totals
          const totals = enhancedMetrics.reduce(
            (acc, company) => {
              if (company.error) return acc;
              acc.totalAssets += company.totalAssets || 0;
              acc.totalLiabilities += company.totalLiabilities || 0;
              acc.totalEquity += company.totalEquity || 0;
              acc.totalCash += company.cashPosition || 0;
              acc.totalRevenue += company.revenue || 0;
              acc.totalProfit += company.netProfit || 0;
              return acc;
            },
            {
              totalAssets: 0,
              totalLiabilities: 0,
              totalEquity: 0,
              totalCash: 0,
              totalRevenue: 0,
              totalProfit: 0,
            }
          );

          const balancedCompanies = enhancedMetrics.filter(
            (c) => !c.error && c.balanced
          ).length;

          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
                  <!-- ENHANCED FINANCIAL OVERVIEW -->
                  <div class="dashboard-grid" style="grid-template-columns: repeat(3, 1fr);">

                    <div class="dashboard-card">
                      <h3>üìä Financial Position</h3>
                      <div class="metric">
                        <span>Total Assets</span>
                        <span class="metric-value">$${totals.totalAssets.toLocaleString()}</span>
                      </div>
                      <div class="metric">
                        <span>Total Liabilities</span>
                        <span class="metric-value">$${totals.totalLiabilities.toLocaleString()}</span>
                      </div>
                      <div class="metric">
                        <span>Net Equity</span>
                        <span class="metric-value">$${totals.totalEquity.toLocaleString()}</span>
                      </div>
                      <div class="metric">
                        <span>Net Worth</span>
                        <span class="metric-value">$${(
                          totals.totalAssets - totals.totalLiabilities
                        ).toLocaleString()}</span>
                      </div>
                    </div>

                    <div class="dashboard-card">
                      <h3>üí∞ Cash & Performance</h3>
                      <div class="metric">
                        <span>Total Cash Position</span>
                        <span class="metric-value">$${totals.totalCash.toLocaleString()}</span>
                      </div>
                      <div class="metric">
                        <span>Annual Revenue</span>
                        <span class="metric-value">$${totals.totalRevenue.toLocaleString()}</span>
                      </div>
                      <div class="metric">
                        <span>Net Profit</span>
                        <span class="metric-value ${
                          totals.totalProfit > 0 ? "" : "negative"
                        }">$${totals.totalProfit.toLocaleString()}</span>
                      </div>
                      <div class="metric">
                        <span>Profit Margin</span>
                        <span class="metric-value">${
                          totals.totalRevenue > 0
                            ? (
                                (totals.totalProfit / totals.totalRevenue) *
                                100
                              ).toFixed(1)
                            : 0
                        }%</span>
                      </div>
                    </div>

                    <div class="dashboard-card">
                      <h3>‚öñÔ∏è Health & Risk</h3>
                      <div class="metric">
                        <span>Companies</span>
                        <span class="metric-value">${
                          enhancedMetrics.length
                        }</span>
                      </div>
                      <div class="metric">
                        <span>Balanced Books</span>
                        <span class="metric-value ${
                          balancedCompanies === enhancedMetrics.length
                            ? ""
                            : "negative"
                        }">${balancedCompanies}/${enhancedMetrics.length}</span>
                      </div>
                      <div class="metric">
                        <span>Debt/Equity Ratio</span>
                        <span class="metric-value">${
                          totals.totalEquity > 0
                            ? (
                                totals.totalLiabilities / totals.totalEquity
                              ).toFixed(2)
                            : "N/A"
                        }</span>
                      </div>
                      <div class="metric">
                        <span>Overall Status</span>
                        <span class="metric-value ${
                          balancedCompanies === enhancedMetrics.length
                            ? ""
                            : "negative"
                        }">
                          ${
                            balancedCompanies === enhancedMetrics.length
                              ? "‚úÖ Healthy"
                              : "‚ö†Ô∏è Review Needed"
                          }
                        </span>
                      </div>
                    </div>
                  </div>

                  <!-- COMPANY BREAKDOWN WITH ENHANCED METRICS -->
                  <div class="dashboard-card">
                    <h3>üìà Company Performance Breakdown</h3>
                    ${enhancedMetrics
                      .map(
                        (company) => `
                      <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; margin: 10px 0; background: ${
                        company.balanced ? "#f8fff8" : "#fff8f8"
                      };">

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                          <strong style="font-size: 16px;">${company.companyName.replace(
                            "Rirratjingu ",
                            ""
                          )}</strong>
                          <span class="metric-value ${
                            company.error
                              ? "negative"
                              : company.balanced
                              ? ""
                              : "negative"
                          }" style="font-size: 14px;">
                            ${
                              company.error
                                ? "‚ö†Ô∏è Data Error"
                                : company.balanced
                                ? "‚úÖ Balanced"
                                : "‚ùå Imbalanced"
                            }
                          </span>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 13px;">
                          <div>
                            <div style="color: #666; margin-bottom: 3px;">Assets</div>
                            <div style="font-weight: 600;">$${(
                              company.totalAssets || 0
                            ).toLocaleString()}</div>
                          </div>
                          <div>
                            <div style="color: #666; margin-bottom: 3px;">Revenue</div>
                            <div style="font-weight: 600;">$${(
                              company.revenue || 0
                            ).toLocaleString()}</div>
                          </div>
                          <div>
                            <div style="color: #666; margin-bottom: 3px;">Net Profit</div>
                            <div style="font-weight: 600; color: ${
                              (company.netProfit || 0) > 0
                                ? "#27ae60"
                                : "#e74c3c"
                            };">$${(
                          company.netProfit || 0
                        ).toLocaleString()}</div>
                          </div>
                          <div>
                            <div style="color: #666; margin-bottom: 3px;">Profit Margin</div>
                            <div style="font-weight: 600;">${(
                              company.netProfitMargin || 0
                            ).toFixed(1)}%</div>
                          </div>
                        </div>

                        ${
                          !company.error
                            ? `
                          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 13px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0;">
                            <div>
                              <div style="color: #666; margin-bottom: 3px;">Cash Position</div>
                              <div style="font-weight: 600;">$${(
                                company.cashPosition || 0
                              ).toLocaleString()}</div>
                            </div>
                            <div>
                              <div style="color: #666; margin-bottom: 3px;">Current Ratio</div>
                              <div style="font-weight: 600;">${(
                                company.currentRatio || 0
                              ).toFixed(2)}</div>
                            </div>
                            <div>
                              <div style="color: #666; margin-bottom: 3px;">ROA</div>
                              <div style="font-weight: 600;">${(
                                company.returnOnAssets || 0
                              ).toFixed(1)}%</div>
                            </div>
                            <div>
                              <div style="color: #666; margin-bottom: 3px;">D/E Ratio</div>
                              <div style="font-weight: 600;">${(
                                company.debtToEquity || 0
                              ).toFixed(2)}</div>
                            </div>
                          </div>
                        `
                            : ""
                        }
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                `;
        } catch (error) {
          console.error("Error in enhanced loadOverviewDataWithYoY:", error);
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
                  <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <h3>Error Loading Enhanced Data</h3>
                    <p>Failed to load dashboard data: ${error.message}</p>
                    <button onclick="loadDashboardData()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                      Retry
                    </button>
                  </div>
                `;
        }
      }

      async function loadTrialBalanceData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
                  <div style="text-align: center; padding: 40px; color: #666;">
                    <h3>No Companies Selected</h3>
                    <p>Please select companies using the filters above to view trial balance.</p>
                  </div>
                `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
                <div class="loading">
                  <div class="loading-spinner"></div>
                  Loading consolidated trial balance data...
                </div>
              `;

        try {
          // Build consolidated data from selected companies only
          let consolidatedData = null;
          if (activeCompanyFilters.length > 0) {
            consolidatedData = {
              companies: [],
              consolidated: {
                totals: { totalAssets: 0, totalLiabilities: 0, totalEquity: 0 },
                balanceCheck: { debitsEqualCredits: true },
              },
              summary: {
                totalCompanies: 0,
                totalAccounts: 0,
                balancedCompanies: 0,
              },
            };
          }

          // Get individual trial balances for selected companies
          const trialBalanceData = [];
          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            const orgName = getOrganizationName(connectedCompany.tenantName);
            const response = await fetch("/api/trial-balance", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: orgName }),
            });

            if (response.ok) {
              const data = await response.json();
              trialBalanceData.push({
                companyName: connectedCompany.tenantName.replace(
                  "Rirratjingu ",
                  ""
                ),
                ...data,
              });

              // Add to consolidated data
              if (consolidatedData) {
                consolidatedData.companies.push({
                  sections: {
                    assets: { accounts: data.trialBalance.assets },
                    liabilities: { accounts: data.trialBalance.liabilities },
                    equity: { accounts: data.trialBalance.equity },
                  },
                });

                // Update consolidated totals
                consolidatedData.consolidated.totals.totalAssets +=
                  data.trialBalance.totals.totalAssets;
                consolidatedData.consolidated.totals.totalLiabilities +=
                  data.trialBalance.totals.totalLiabilities;
                consolidatedData.consolidated.totals.totalEquity +=
                  data.trialBalance.totals.totalEquity;

                consolidatedData.summary.totalCompanies++;
                consolidatedData.summary.totalAccounts +=
                  data.trialBalance.assets.length +
                  data.trialBalance.liabilities.length +
                  data.trialBalance.equity.length;

                if (data.balanceCheck.debitsEqualCredits) {
                  consolidatedData.summary.balancedCompanies++;
                } else {
                  consolidatedData.consolidated.balanceCheck.debitsEqualCredits = false;
                }
              }
            }
          }
          // Render consolidated + individual trial balances with scroll
          renderTrialBalanceWithConsolidated(
            consolidatedData,
            trialBalanceData
          );
        } catch (error) {
          dashboardElement.innerHTML = `
                  <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <h3>Error Loading Trial Balance</h3>
                    <p>${error.message}</p>
                  </div>
                `;
        }
      }

      function renderTrialBalanceWithConsolidated(
        consolidatedData,
        individualData
      ) {
        const dashboardElement = document.getElementById("dashboardData");

        let consolidatedHtml = "";
        if (consolidatedData && consolidatedData.companies) {
          // Build consolidated accounts by combining all companies
          const consolidatedAccounts = {
            assets: {},
            liabilities: {},
            equity: {},
          };

          // Aggregate accounts across all companies
          consolidatedData.companies.forEach((company) => {
            ["assets", "liabilities", "equity"].forEach((category) => {
              if (company.sections && company.sections[category]) {
                company.sections[category].accounts.forEach((account) => {
                  if (!consolidatedAccounts[category][account.name]) {
                    consolidatedAccounts[category][account.name] = 0;
                  }
                  consolidatedAccounts[category][account.name] +=
                    account.balance;
                });
              }
            });
          });

          // Convert to arrays and sort
          const assetAccounts = Object.entries(consolidatedAccounts.assets)
            .map(([name, balance]) => ({ name, balance }))
            .sort((a, b) => a.name.localeCompare(b.name));
          const liabilityAccounts = Object.entries(
            consolidatedAccounts.liabilities
          )
            .map(([name, balance]) => ({ name, balance }))
            .sort((a, b) => a.name.localeCompare(b.name));
          const equityAccounts = Object.entries(consolidatedAccounts.equity)
            .map(([name, balance]) => ({ name, balance }))
            .sort((a, b) => a.name.localeCompare(b.name));

          const totals = consolidatedData.consolidated.totals;
          const balanceCheck = consolidatedData.consolidated.balanceCheck;

          consolidatedHtml = `
            <div class="dashboard-card" style="margin-bottom: 20px;">
              <h3>Consolidated Trial Balance - All Selected Companies</h3>
              <div style="margin-bottom: 15px;">
                <strong>Status:</strong>
                <span style="color: ${
                  balanceCheck.debitsEqualCredits ? "#27ae60" : "#e74c3c"
                };">
                  ${
                    balanceCheck.debitsEqualCredits
                      ? "‚úÖ Balanced"
                      : "‚ö†Ô∏è Out of Balance"
                  }
                </span>
                <span style="margin-left: 20px; font-size: 14px; color: #666;">
                  Companies: ${consolidatedData.summary?.totalCompanies || 0} |
                  Total Accounts: ${
                    consolidatedData.summary?.totalAccounts || 0
                  }
                </span>
              </div>

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div>
                  <h4>Assets (${assetAccounts.length} accounts)</h4>
                  <div style="max-height: 60vh; overflow-y: auto;">
                    ${assetAccounts
                      .map(
                        (account) => `
                      <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="font-size: 13px; flex: 1; margin-right: 10px;">${
                          account.name
                        }</span>
                        <span style="font-weight: 600;">$${account.balance.toLocaleString()}</span>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                  <div style="border-top: 2px solid #27ae60; padding: 8px 0; font-weight: bold; color: #27ae60;">
                    Total Assets: $${totals.totalAssets.toLocaleString()}
                  </div>
                </div>

                <div>
                  <h4>Liabilities (${liabilityAccounts.length} accounts)</h4>
                  <div style="max-height: 60vh; overflow-y: auto;">
                    ${liabilityAccounts
                      .map(
                        (account) => `
                      <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="font-size: 13px; flex: 1; margin-right: 10px;">${
                          account.name
                        }</span>
                        <span style="font-weight: 600;">$${account.balance.toLocaleString()}</span>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                  <div style="border-top: 2px solid #e74c3c; padding: 8px 0; font-weight: bold; color: #e74c3c;">
                    Total Liabilities: $${Math.abs(
                      totals.totalLiabilities
                    ).toLocaleString()}
                  </div>
                </div>

                <div>
                  <h4>Equity (${equityAccounts.length} accounts)</h4>
                  <div style="max-height: 60vh; overflow-y: auto;">
                    ${equityAccounts
                      .map(
                        (account) => `
                      <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="font-size: 13px; flex: 1; margin-right: 10px;">${
                          account.name
                        }</span>
                        <span style="font-weight: 600;">$${account.balance.toLocaleString()}</span>
                      </div>
                    `
                      )
                      .join("")}
                  </div>
                  <div style="border-top: 2px solid #3498db; padding: 8px 0; font-weight: bold; color: #3498db;">
                    Total Equity: $${totals.totalEquity.toLocaleString()}
                  </div>
                </div>
              </div>
            </div>
          `;
        }

        dashboardElement.innerHTML = consolidatedHtml;
      }

      async function loadCashFlowData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view cash flow.</p>
      </div>
    `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading cash flow data...
    </div>
  `;

        try {
          const cashData = [];
          let consolidatedCash = {
            totalCash: 0,
            bankAccounts: {},
            companies: [],
          };

          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            const orgName = getOrganizationName(connectedCompany.tenantName);
            const response = await fetch("/api/cash-position", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: orgName }),
            });

            if (response.ok) {
              const data = await response.json();
              const companyData = {
                companyName: connectedCompany.tenantName.replace(
                  "Rirratjingu ",
                  ""
                ),
                ...data,
              };

              cashData.push(companyData);

              // Build consolidated data
              consolidatedCash.totalCash += data.totalCash || 0;
              consolidatedCash.companies.push(companyData);

              // Aggregate bank accounts (combine accounts with same name)
              if (data.bankAccounts) {
                data.bankAccounts.forEach((account) => {
                  const accountKey = account.name;
                  if (!consolidatedCash.bankAccounts[accountKey]) {
                    consolidatedCash.bankAccounts[accountKey] = {
                      name: account.name,
                      balance: 0,
                      code: account.code,
                      companies: [],
                    };
                  }
                  consolidatedCash.bankAccounts[accountKey].balance +=
                    account.balance;
                  consolidatedCash.bankAccounts[accountKey].companies.push({
                    company: companyData.companyName,
                    balance: account.balance,
                  });
                });
              }
            }
          }

          // Convert consolidated bank accounts to array
          const consolidatedBankAccounts = Object.values(
            consolidatedCash.bankAccounts
          ).sort((a, b) => b.balance - a.balance);

          renderCashFlowWithConsolidated(
            consolidatedCash,
            consolidatedBankAccounts,
            cashData
          );
        } catch (error) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading Cash Flow Data</h3>
        <p>${error.message}</p>
      </div>
    `;
        }
      }

      function renderCashFlowWithConsolidated(
        consolidatedCash,
        consolidatedBankAccounts,
        individualData
      ) {
        const dashboardElement = document.getElementById("dashboardData");

        const consolidatedHtml = `
    <div class="dashboard-card" style="margin-bottom: 20px;">
      <h3>Consolidated Cash Position - All Selected Companies</h3>
      <div style="margin-bottom: 15px;">
        <strong>Total Cash:</strong> $${consolidatedCash.totalCash.toLocaleString()}
        <span style="margin-left: 20px; font-size: 14px; color: #666;">
          Companies: ${consolidatedCash.companies.length} | 
          Bank Accounts: ${consolidatedBankAccounts.length}
        </span>
      </div>
      
      ${
        consolidatedBankAccounts.length > 0
          ? `
        <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px;">
          ${consolidatedBankAccounts
            .map(
              (account) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
              <div>
                <div style="font-weight: 600;">${account.name}</div>
                <div style="font-size: 12px; color: #666;">
                  ${account.companies
                    .map(
                      (comp) =>
                        `${comp.company}: $${comp.balance.toLocaleString()}`
                    )
                    .join(" | ")}
                </div>
              </div>
              <div style="font-weight: 600; text-align: right;">
                $${account.balance.toLocaleString()}
              </div>
            </div>
          `
            )
            .join("")}
        </div>
      `
          : `
        <div style="text-align: center; padding: 20px; color: #666;">
          No bank accounts found
        </div>
      `
      }
    </div>
  `;

        dashboardElement.innerHTML = consolidatedHtml;
      }

      async function loadProfitLossData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view P&L.</p>
      </div>
    `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading consolidated profit & loss data...
    </div>
  `;

        try {
          const plData = [];
          let consolidatedPL = {
            totalRevenue: 0,
            totalExpenses: 0,
            netProfit: 0,
            revenueAccounts: {},
            expenseAccounts: {},
            companies: [],
          };

          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            const orgName = getOrganizationName(connectedCompany.tenantName);
            const response = await fetch("/api/profit-loss-summary", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organizationName: orgName }),
            });

            if (response.ok) {
              const data = await response.json();
              const companyData = {
                companyName: connectedCompany.tenantName.replace(
                  "Rirratjingu ",
                  ""
                ),
                ...data,
              };

              plData.push(companyData);
              consolidatedPL.companies.push(companyData);

              // Aggregate P&L totals
              consolidatedPL.totalRevenue += data.summary.totalRevenue || 0;
              consolidatedPL.totalExpenses += data.summary.totalExpenses || 0;
              consolidatedPL.netProfit += data.summary.netProfit || 0;

              // Aggregate revenue accounts
              if (data.summary.revenueAccounts) {
                data.summary.revenueAccounts.forEach((account) => {
                  if (!consolidatedPL.revenueAccounts[account.name]) {
                    consolidatedPL.revenueAccounts[account.name] = 0;
                  }
                  consolidatedPL.revenueAccounts[account.name] +=
                    account.amount;
                });
              }

              // Aggregate expense accounts
              if (data.summary.expenseAccounts) {
                data.summary.expenseAccounts.forEach((account) => {
                  if (!consolidatedPL.expenseAccounts[account.name]) {
                    consolidatedPL.expenseAccounts[account.name] = 0;
                  }
                  consolidatedPL.expenseAccounts[account.name] +=
                    account.amount;
                });
              }
            }
          }

          // Convert account objects to sorted arrays
          const consolidatedRevenueAccounts = Object.entries(
            consolidatedPL.revenueAccounts
          )
            .map(([name, amount]) => ({ name, amount }))
            .sort((a, b) => b.amount - a.amount);

          const consolidatedExpenseAccounts = Object.entries(
            consolidatedPL.expenseAccounts
          )
            .map(([name, amount]) => ({ name, amount }))
            .sort((a, b) => b.amount - a.amount);

          renderConsolidatedProfitLoss(
            consolidatedPL,
            consolidatedRevenueAccounts,
            consolidatedExpenseAccounts
          );
        } catch (error) {
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading P&L Data</h3>
        <p>${error.message}</p>
      </div>
    `;
        }
      }

      function renderConsolidatedProfitLoss(
        consolidatedPL,
        revenueAccounts,
        expenseAccounts
      ) {
        const dashboardElement = document.getElementById("dashboardData");

        const profitMargin =
          consolidatedPL.totalRevenue > 0
            ? (
                (consolidatedPL.netProfit / consolidatedPL.totalRevenue) *
                100
              ).toFixed(1)
            : 0;

        const consolidatedHtml = `
    <div class="dashboard-card" style="margin-bottom: 20px;">
      <h3>Consolidated Profit & Loss - All Selected Companies</h3>
      <div style="margin-bottom: 15px;">
        <span style="margin-right: 20px; font-size: 14px; color: #666;">
          Companies: ${consolidatedPL.companies.length} | 
          Revenue Accounts: ${revenueAccounts.length} | 
          Expense Accounts: ${expenseAccounts.length}
        </span>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <h4>Revenue (${revenueAccounts.length} accounts)</h4>
          <div style="max-height: 50vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px;">
            ${revenueAccounts
              .map(
                (account) => `
              <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="font-size: 13px; flex: 1; margin-right: 10px;">${
                  account.name
                }</span>
                <span style="font-weight: 600;">$${account.amount.toLocaleString()}</span>
              </div>
            `
              )
              .join("")}
          </div>
          <div style="border-top: 2px solid #27ae60; padding: 8px 0; font-weight: bold; color: #27ae60; margin-top: 10px;">
            Total Revenue: $${consolidatedPL.totalRevenue.toLocaleString()}
          </div>
        </div>

        <div>
          <h4>Expenses (${expenseAccounts.length} accounts)</h4>
          <div style="max-height: 50vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px;">
            ${expenseAccounts
              .map(
                (account) => `
              <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="font-size: 13px; flex: 1; margin-right: 10px;">${
                  account.name
                }</span>
                <span style="font-weight: 600;">$${account.amount.toLocaleString()}</span>
              </div>
            `
              )
              .join("")}
          </div>
          <div style="border-top: 2px solid #e74c3c; padding: 8px 0; font-weight: bold; color: #e74c3c; margin-top: 10px;">
            Total Expenses: $${consolidatedPL.totalExpenses.toLocaleString()}
          </div>
        </div>
      </div>

      <div style="margin-top: 20px; padding: 15px; background: ${
        consolidatedPL.netProfit >= 0 ? "#f8fff8" : "#fff8f8"
      }; border-radius: 6px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="font-weight: bold; font-size: 18px;">Net Profit:</span>
          <span style="font-weight: bold; font-size: 20px; color: ${
            consolidatedPL.netProfit >= 0 ? "#27ae60" : "#e74c3c"
          };">
            $${consolidatedPL.netProfit.toLocaleString()}
          </span>
        </div>
        <div style="margin-top: 8px; display: flex; justify-content: space-between;">
          <span>Profit Margin: ${profitMargin}%</span>
          <span>Period: August 2025 (Testing)</span>
        </div>
      </div>
    </div>
  `;

        dashboardElement.innerHTML = consolidatedHtml;
      }

      async function loadYearOverYearData() {
        // Implementation continues...
      }

      async function loadYearOverYearData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>No Companies Selected</h3>
        <p>Please select companies using the filters above to view YoY analysis.</p>
      </div>
    `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      Loading consolidated year-over-year analysis...
    </div>
  `;

        try {
          const yoyData = [];
          const monthlyData = [];
          let consolidatedYoY = {
            current: {
              revenue: 0,
              expenses: 0,
              profit: 0,
              assets: 0,
              equity: 0,
            },
            previous: {
              revenue: 0,
              expenses: 0,
              profit: 0,
              assets: 0,
              equity: 0,
            },
            growth: {
              revenue: 0,
              expenses: 0,
              profit: 0,
              assets: 0,
              equity: 0,
            },
            companies: [],
          };

          // Load both YoY and Monthly data for each selected company
          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            try {
              const orgName = getOrganizationName(connectedCompany.tenantName);

              // Load YoY and Monthly data in parallel
              const [yoyResponse, monthlyResponse] = await Promise.all([
                fetch("/api/yoy-analysis", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ organizationName: orgName }),
                }),
                fetch("/api/monthly-breakdown", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ organizationName: orgName }),
                }),
              ]);

              if (yoyResponse.ok) {
                const data = await yoyResponse.json();
                const companyYoyData = {
                  companyName: connectedCompany.tenantName.replace(
                    "Rirratjingu ",
                    ""
                  ),
                  tenantName: data.tenantName,
                  analysis: data.analysis,
                  error: false,
                };
                yoyData.push(companyYoyData);

                // Add to consolidated totals
                const current = data.analysis.periods.current;
                const previous = data.analysis.periods.previous;

                consolidatedYoY.current.revenue += current.revenue || 0;
                consolidatedYoY.current.expenses +=
                  current.revenue - current.profit || 0;
                consolidatedYoY.current.profit += current.profit || 0;
                consolidatedYoY.current.assets += current.assets || 0;
                consolidatedYoY.current.equity += current.equity || 0;

                consolidatedYoY.previous.revenue += previous.revenue || 0;
                consolidatedYoY.previous.expenses +=
                  previous.revenue - previous.profit || 0;
                consolidatedYoY.previous.profit += previous.profit || 0;
                consolidatedYoY.previous.assets += previous.assets || 0;
                consolidatedYoY.previous.equity += previous.equity || 0;

                consolidatedYoY.companies.push(companyYoyData);
              }

              if (monthlyResponse.ok) {
                const monthlyResult = await monthlyResponse.json();
                monthlyData.push({
                  companyName: connectedCompany.tenantName.replace(
                    "Rirratjingu ",
                    ""
                  ),
                  tenantName: monthlyResult.tenantName,
                  monthlyBreakdown: monthlyResult.monthlyBreakdown,
                  totals: monthlyResult.totals,
                  error: false,
                });
              }
            } catch (error) {
              console.error(
                `Error loading data for ${connectedCompany.tenantName}:`,
                error
              );
            }
          }

          // Calculate consolidated growth rates
          consolidatedYoY.growth.revenue = calculateGrowthRate(
            consolidatedYoY.previous.revenue,
            consolidatedYoY.current.revenue
          );
          consolidatedYoY.growth.expenses = calculateGrowthRate(
            consolidatedYoY.previous.expenses,
            consolidatedYoY.current.expenses
          );
          consolidatedYoY.growth.profit = calculateGrowthRate(
            consolidatedYoY.previous.profit,
            consolidatedYoY.current.profit
          );
          consolidatedYoY.growth.assets = calculateGrowthRate(
            consolidatedYoY.previous.assets,
            consolidatedYoY.current.assets
          );
          consolidatedYoY.growth.equity = calculateGrowthRate(
            consolidatedYoY.previous.equity,
            consolidatedYoY.current.equity
          );

          // Render consolidated YoY + individual companies with scroll
          renderConsolidatedYoYAnalysis(consolidatedYoY, yoyData, monthlyData);
        } catch (error) {
          console.error("Error in YoY analysis:", error);
          dashboardElement.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <h3>Error Loading YoY Data</h3>
        <p>Failed to load year-over-year analysis: ${error.message}</p>
      </div>
    `;
        }
      }

      function renderConsolidatedYoYAnalysis(
        consolidatedYoY,
        yoyData,
        monthlyData
      ) {
        const dashboardElement = document.getElementById("dashboardData");

        // Get period labels from first valid company
        const firstValidCompany = yoyData.find((d) => !d.error);
        const currentLabel = firstValidCompany
          ? firstValidCompany.analysis.periods.current.label
          : "Current Year";
        const previousLabel = firstValidCompany
          ? firstValidCompany.analysis.periods.previous.label
          : "Previous Year";

        const consolidatedHtml = `
    <div class="dashboard-card" style="margin-bottom: 20px;">
      <h3>Consolidated Year-over-Year Analysis - All Selected Companies</h3>
      <div style="margin-bottom: 15px;">
        <span style="font-size: 14px; color: #666;">
          Companies: ${consolidatedYoY.companies.length} | 
          Period: ${currentLabel} vs ${previousLabel}
        </span>
      </div>

      <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px;">
        <div class="dashboard-card" style="padding: 15px;">
          <h4>Revenue Performance</h4>
          <div class="metric">
            <span>${currentLabel}</span>
            <span class="metric-value">$${consolidatedYoY.current.revenue.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>${previousLabel}</span>
            <span class="metric-value">$${consolidatedYoY.previous.revenue.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Growth</span>
            <span class="metric-value ${
              consolidatedYoY.growth.revenue >= 0 ? "" : "negative"
            }">
              ${
                consolidatedYoY.growth.revenue >= 0 ? "+" : ""
              }${consolidatedYoY.growth.revenue.toFixed(1)}%
            </span>
          </div>
        </div>

        <div class="dashboard-card" style="padding: 15px;">
          <h4>Expense Performance</h4>
          <div class="metric">
            <span>${currentLabel}</span>
            <span class="metric-value">$${consolidatedYoY.current.expenses.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>${previousLabel}</span>
            <span class="metric-value">$${consolidatedYoY.previous.expenses.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Growth</span>
            <span class="metric-value ${
              consolidatedYoY.growth.expenses >= 0 ? "negative" : ""
            }">
              ${
                consolidatedYoY.growth.expenses >= 0 ? "+" : ""
              }${consolidatedYoY.growth.expenses.toFixed(1)}%
            </span>
          </div>
        </div>

        <div class="dashboard-card" style="padding: 15px;">
          <h4>Profit Performance</h4>
          <div class="metric">
            <span>${currentLabel}</span>
            <span class="metric-value ${
              consolidatedYoY.current.profit >= 0 ? "" : "negative"
            }">$${consolidatedYoY.current.profit.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>${previousLabel}</span>
            <span class="metric-value ${
              consolidatedYoY.previous.profit >= 0 ? "" : "negative"
            }">$${consolidatedYoY.previous.profit.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Growth</span>
            <span class="metric-value ${
              consolidatedYoY.growth.profit >= 0 ? "" : "negative"
            }">
              ${
                consolidatedYoY.growth.profit >= 0 ? "+" : ""
              }${consolidatedYoY.growth.profit.toFixed(1)}%
            </span>
          </div>
        </div>

        <div class="dashboard-card" style="padding: 15px;">
          <h4>Asset Growth</h4>
          <div class="metric">
            <span>${currentLabel}</span>
            <span class="metric-value">$${consolidatedYoY.current.assets.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>${previousLabel}</span>
            <span class="metric-value">$${consolidatedYoY.previous.assets.toLocaleString()}</span>
          </div>
          <div class="metric">
            <span>Growth</span>
            <span class="metric-value ${
              consolidatedYoY.growth.assets >= 0 ? "" : "negative"
            }">
              ${
                consolidatedYoY.growth.assets >= 0 ? "+" : ""
              }${consolidatedYoY.growth.assets.toFixed(1)}%
            </span>
          </div>
        </div>

        <div class="dashboard-card" style="padding: 15px;">
          <h4>Financial Health</h4>
          <div class="metric">
            <span>Current Margin</span>
            <span class="metric-value">
              ${
                consolidatedYoY.current.revenue > 0
                  ? (
                      (consolidatedYoY.current.profit /
                        consolidatedYoY.current.revenue) *
                      100
                    ).toFixed(1)
                  : 0
              }%
            </span>
          </div>
          <div class="metric">
            <span>Prior Margin</span>
            <span class="metric-value">
              ${
                consolidatedYoY.previous.revenue > 0
                  ? (
                      (consolidatedYoY.previous.profit /
                        consolidatedYoY.previous.revenue) *
                      100
                    ).toFixed(1)
                  : 0
              }%
            </span>
          </div>
          <div class="metric">
            <span>Trend</span>
            <span class="metric-value ${
              consolidatedYoY.growth.revenue > 0 &&
              consolidatedYoY.growth.profit > 0
                ? ""
                : "negative"
            }">
              ${
                consolidatedYoY.growth.revenue > 0 &&
                consolidatedYoY.growth.profit > 0
                  ? "Positive"
                  : "Declining"
              }
            </span>
          </div>
        </div>
      </div>

      <!-- Monthly Performance Breakdown for first company as sample -->
      ${monthlyData.length > 0 ? renderMonthlyCard(monthlyData) : ""}
    </div>
  `;

        const individualHtml = `
    <div style="height: 50vh; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px;">
      <h3>Individual Company Performance</h3>
      ${yoyData
        .map((company) => {
          if (company.error) {
            return `
            <div style="border: 1px solid #e74c3c; border-radius: 6px; padding: 15px; margin: 10px 0; background: #fff5f5;">
              <strong style="color: #e74c3c;">${company.companyName}</strong>
              <div style="color: #666; margin-top: 5px;">Error loading YoY data</div>
            </div>
          `;
          }

          const current = company.analysis.periods.current;
          const previous = company.analysis.periods.previous;
          const growth = company.analysis.growth;

          return `
          <div style="border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; margin: 10px 0; background: #fafafa;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <strong style="font-size: 16px;">${company.companyName}</strong>
              <div style="display: flex; gap: 15px; font-size: 14px;">
                <span style="color: ${
                  growth.revenue >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  Revenue: ${
                    growth.revenue >= 0 ? "+" : ""
                  }${growth.revenue.toFixed(1)}%
                </span>
                <span style="color: ${
                  growth.profit >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  Profit: ${
                    growth.profit >= 0 ? "+" : ""
                  }${growth.profit.toFixed(1)}%
                </span>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; font-size: 13px;">
              <div>
                <div style="color: #666; margin-bottom: 3px;">${currentLabel} Revenue</div>
                <div style="font-weight: 600;">$${current.revenue.toLocaleString()}</div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">${previousLabel} Revenue</div>
                <div style="font-weight: 600;">$${previous.revenue.toLocaleString()}</div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">${currentLabel} Profit</div>
                <div style="font-weight: 600; color: ${
                  current.profit >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  $${current.profit.toLocaleString()}
                </div>
              </div>
              <div>
                <div style="color: #666; margin-bottom: 3px;">${previousLabel} Profit</div>
                <div style="font-weight: 600; color: ${
                  previous.profit >= 0 ? "#27ae60" : "#e74c3c"
                };">
                  $${previous.profit.toLocaleString()}
                </div>
              </div>
            </div>
          </div>
        `;
        })
        .join("")}
    </div>
  `;

        dashboardElement.innerHTML = consolidatedHtml;
      }

      // Monthly Card component
      function renderMonthlyCard(monthlyData) {
        if (!monthlyData || monthlyData.length === 0) {
          return `
                  <div class="dashboard-card">
                    <h3>Monthly Breakdown</h3>
                    <div style="text-align: center; padding: 20px; color: #666;">
                      No monthly data available
                    </div>
                  </div>
                `;
        }

        // Use first company's data for display (extend later for multi-company)
        const companyData = monthlyData[0];
        const months = companyData.monthlyBreakdown;

        // Calculate totals
        const totals = {
          revenue: months.reduce((sum, month) => sum + month.revenue, 0),
          expenses: months.reduce((sum, month) => sum + month.expenses, 0),
          profit: months.reduce((sum, month) => sum + month.netProfit, 0),
        };

        return `
                <div class="dashboard-card">
                  <h3>Monthly Performance Breakdown (${
                    companyData.companyName
                  })</h3>

                  <!-- Monthly Grid -->
                  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
                    ${months
                      .map(
                        (month, index) => `
                      <div style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px; background: ${
                        month.netProfit >= 0 ? "#f8fff8" : "#fff8f8"
                      }; font-size: 12px;">
                        <div style="font-weight: 600; margin-bottom: 4px; color: #2c3e50;">${
                          month.label
                        }</div>
                        <div class="metric" style="padding: 2px 0; border: none;">
                          <span style="font-size: 11px; color: #666;">Revenue</span>
                          <span style="font-weight: 600; font-size: 11px;">$${(
                            month.revenue / 1000
                          ).toFixed(0)}K</span>
                        </div>
                        <div class="metric" style="padding: 2px 0; border: none;">
                          <span style="font-size: 11px; color: #666;">Expenses</span>
                          <span style="font-weight: 600; font-size: 11px;">$${(
                            month.expenses / 1000
                          ).toFixed(0)}K</span>
                        </div>
                        <div class="metric" style="padding: 2px 0; border: none;">
                          <span style="font-size: 11px; color: #666;">Profit</span>
                          <span style="font-weight: 600; font-size: 11px; color: ${
                            month.netProfit >= 0 ? "#27ae60" : "#e74c3c"
                          };">
                            $${(month.netProfit / 1000).toFixed(0)}K
                          </span>
                        </div>
                      </div>
                    `
                      )
                      .join("")}
                  </div>

                  <!-- Totals Summary -->
                  <div style="border-top: 2px solid #2c3e50; padding-top: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                      <div class="metric">
                        <span>Total Revenue (12 months)</span>
                        <span class="metric-value">$${totals.revenue.toLocaleString()}</span>
                      </div>
                      <div class="metric">
                        <span>Total Expenses (12 months)</span>
                        <span class="metric-value">$${totals.expenses.toLocaleString()}</span>
                      </div>
                      <div class="metric">
                        <span>Net Profit (12 months)</span>
                        <span class="metric-value ${
                          totals.profit >= 0 ? "" : "negative"
                        }">$${totals.profit.toLocaleString()}</span>
                      </div>
                      <div class="metric">
                        <span>Average Monthly Profit</span>
                        <span class="metric-value ${
                          totals.profit >= 0 ? "" : "negative"
                        }">$${(totals.profit / 12).toLocaleString()}</span>
                      </div>
                    </div>
                  </div>
                </div>
              `;
      }

      // 7. Generate insights based on YoY data
      function generateYoYInsights(consolidatedYoY, yoyData) {
        const insights = [];
        const validCompanies = yoyData.filter((d) => !d.error);

        // Revenue insights
        if (consolidatedYoY.growth.revenue > 10) {
          insights.push(
            `<strong>Strong Revenue Growth:</strong> Consolidated revenue increased by ${consolidatedYoY.growth.revenue.toFixed(
              1
            )}%, indicating robust business expansion.`
          );
        } else if (consolidatedYoY.growth.revenue < -5) {
          insights.push(
            `<strong>Revenue Decline:</strong> Consolidated revenue decreased by ${Math.abs(
              consolidatedYoY.growth.revenue
            ).toFixed(1)}%, requiring strategic attention.`
          );
        }

        // Profit insights
        if (consolidatedYoY.growth.profit > 15) {
          insights.push(
            `<strong>Excellent Profitability:</strong> Net profit growth of ${consolidatedYoY.growth.profit.toFixed(
              1
            )}% demonstrates strong operational efficiency.`
          );
        } else if (consolidatedYoY.growth.profit < -10) {
          insights.push(
            `<strong>Profitability Concerns:</strong> Net profit declined by ${Math.abs(
              consolidatedYoY.growth.netProfit
            ).toFixed(1)}%, suggesting need for cost management review.`
          );
        }

        // Company performance insights
        const growingCompanies = validCompanies.filter(
          (c) => c.growth.revenue > 0 && c.growth.netProfit > 0
        );
        const decliningCompanies = validCompanies.filter(
          (c) => c.growth.revenue < 0 || c.growth.netProfit < 0
        );

        if (growingCompanies.length > 0) {
          insights.push(
            `<strong>High Performers:</strong> ${growingCompanies
              .map((c) => c.companyName)
              .join(", ")} showing positive growth in both revenue and profit.`
          );
        }

        if (decliningCompanies.length > 0) {
          insights.push(
            `<strong>Areas for Review:</strong> ${decliningCompanies
              .map((c) => c.companyName)
              .join(", ")} may require strategic intervention.`
          );
        }

        // Asset growth insights
        if (consolidatedYoY.growth.assets > 5) {
          insights.push(
            `<strong>Asset Expansion:</strong> ${consolidatedYoY.growth.assets.toFixed(
              1
            )}% asset growth indicates successful capital investment and business development.`
          );
        }

        return insights.length > 0
          ? insights.join("<br><br>")
          : "Analyzing year-over-year trends...";
      }

      async function loadAlertsData() {
        if (activeCompanyFilters.length === 0) {
          const dashboardElement = document.getElementById("dashboardData");
          dashboardElement.innerHTML = `
                  <div style="text-align: center; padding: 40px; color: #666;">
                    <h3>No Companies Selected</h3>
                    <p>Please select companies using the filters above to view alerts.</p>
                  </div>
                `;
          return;
        }

        const dashboardElement = document.getElementById("dashboardData");
        dashboardElement.innerHTML = `
                <div class="loading">
                  <div class="loading-spinner"></div>
                  Analyzing financial data for alerts...
                </div>
              `;

        try {
          const alerts = [];

          // Check each selected company for issues
          for (const tenantId of activeCompanyFilters) {
            const connectedCompany = connectedCompanies.find(
              (c) => c.tenantId === tenantId
            );
            if (!connectedCompany) continue;

            const orgName = getOrganizationName(connectedCompany.tenantName);

            // Get multiple data points for comprehensive alerts
            const [tbResponse, cashResponse, ratiosResponse] =
              await Promise.all([
                fetch("/api/trial-balance", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ organizationName: orgName }),
                }).catch(() => null),
                fetch("/api/cash-position", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ organizationName: orgName }),
                }).catch(() => null),
                fetch("/api/financial-ratios", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ organizationName: orgName }),
                }).catch(() => null),
              ]);

            const companyName = connectedCompany.tenantName.replace(
              "Rirratjingu ",
              ""
            );

            // Parse responses
            const tbData =
              tbResponse && tbResponse.ok ? await tbResponse.json() : null;
            const cashData =
              cashResponse && cashResponse.ok
                ? await cashResponse.json()
                : null;
            const ratiosData =
              ratiosResponse && ratiosResponse.ok
                ? await ratiosResponse.json()
                : null;

            // Check for trial balance issues
            if (tbData && !tbData.balanceCheck.debitsEqualCredits) {
              alerts.push({
                type: "critical",
                company: companyName,
                title: "Trial Balance Imbalance",
                message: `Books are out of balance by $${Math.abs(
                  tbData.balanceCheck.difference
                ).toLocaleString()}`,
                action: "Review journal entries and account reconciliations",
              });
            }

            // Check for cash flow concerns
            if (
              cashData &&
              cashData.totalCash === 0 &&
              cashData.bankAccounts.length > 0
            ) {
              alerts.push({
                type: "warning",
                company: companyName,
                title: "Zero Cash Position",
                message: `${cashData.bankAccounts.length} bank accounts but $0 total cash`,
                action: "Verify bank account balances and connectivity",
              });
            }

            // Check financial ratios for concerning trends
            if (ratiosData) {
              const currentRatio =
                ratiosData.ratios?.liquidity?.currentRatio || 0;
              const debtToEquity =
                ratiosData.ratios?.leverage?.debtToEquity || 0;
              const profitMargin =
                ratiosData.ratios?.profitability?.netProfitMargin || 0;

              if (currentRatio < 1.0 && currentRatio > 0) {
                alerts.push({
                  type: "warning",
                  company: companyName,
                  title: "Low Liquidity Ratio",
                  message: `Current ratio of ${currentRatio.toFixed(
                    2
                  )} indicates potential cash flow issues`,
                  action: "Review accounts payable and receivable timing",
                });
              }

              if (debtToEquity > 2.0) {
                alerts.push({
                  type: "warning",
                  company: companyName,
                  title: "High Debt-to-Equity Ratio",
                  message: `Debt-to-equity ratio of ${debtToEquity.toFixed(
                    2
                  )} may indicate overleveraging`,
                  action: "Consider debt reduction strategies",
                });
              }

              if (profitMargin < -10) {
                alerts.push({
                  type: "critical",
                  company: companyName,
                  title: "Negative Profit Margin",
                  message: `Profit margin of ${profitMargin.toFixed(
                    1
                  )}% indicates significant losses`,
                  action:
                    "Urgent review of operations and cost structure needed",
                });
              }
            }

            // Check for data loading errors
            if (!tbData && !cashData && !ratiosData) {
              alerts.push({
                type: "info",
                company: companyName,
                title: "Data Connection Issues",
                message: "Unable to load financial data for analysis",
                action: "Check Xero connection and token status",
              });
            }
          }

          // Add system-wide alerts
          try {
            const tokenResponse = await fetch("/api/token-status");
            if (tokenResponse.ok) {
              const tokenStatus = await tokenResponse.json();
              if (tokenStatus.expiringTokens > 0) {
                alerts.push({
                  type: "warning",
                  company: "System",
                  title: "OAuth Token Expiry",
                  message: `${tokenStatus.expiringTokens} token(s) expiring soon`,
                  action: "Refresh OAuth connections to maintain data access",
                });
              }
            }
          } catch (error) {
            // Token status check failed, add alert
            alerts.push({
              type: "info",
              company: "System",
              title: "Token Status Unknown",
              message: "Unable to check OAuth token expiry status",
              action: "Monitor connection stability",
            });
          }

          // Render alerts dashboard
          const criticalAlerts = alerts.filter((a) => a.type === "critical");
          const warningAlerts = alerts.filter((a) => a.type === "warning");
          const infoAlerts = alerts.filter((a) => a.type === "info");

          dashboardElement.innerHTML = `
                  <div class="dashboard-grid">
                    <div class="dashboard-card">
                      <h3>Alert Summary</h3>
                      <div class="metric">
                        <span>Critical Issues</span>
                        <span class="metric-value ${
                          criticalAlerts.length > 0 ? "negative" : ""
                        }">${criticalAlerts.length}</span>
                      </div>
                      <div class="metric">
                        <span>Warnings</span>
                        <span class="metric-value">${
                          warningAlerts.length
                        }</span>
                      </div>
                      <div class="metric">
                        <span>Information</span>
                        <span class="metric-value">${infoAlerts.length}</span>
                      </div>
                      <div class="metric">
                        <span>Overall Status</span>
                        <span class="metric-value ${
                          criticalAlerts.length > 0
                            ? "negative"
                            : warningAlerts.length > 0
                            ? ""
                            : ""
                        }">
                          ${
                            criticalAlerts.length > 0
                              ? "üî¥ Critical"
                              : warningAlerts.length > 0
                              ? "üü° Caution"
                              : "üü¢ Healthy"
                          }
                        </span>
                      </div>
                    </div>
                  </div>

                  <div class="dashboard-card">
                    <h3>Financial Alerts & Recommendations</h3>

                    ${
                      alerts.length === 0
                        ? `
                      <div style="text-align: center; padding: 40px; color: #27ae60;">
                        <h4>üü¢ All Systems Healthy</h4>
                        <p>No financial alerts detected for the selected companies.</p>
                      </div>
                    `
                        : alerts
                            .map(
                              (alert) => `
                      <div style="padding: 15px; margin: 10px 0; border-radius: 6px; border-left: 4px solid ${
                        alert.type === "critical"
                          ? "#e74c3c"
                          : alert.type === "warning"
                          ? "#f39c12"
                          : "#3498db"
                      }; background: ${
                                alert.type === "critical"
                                  ? "#fff5f5"
                                  : alert.type === "warning"
                                  ? "#fffdf5"
                                  : "#f8fffe"
                              };">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                          <div>
                            <strong style="color: ${
                              alert.type === "critical"
                                ? "#c0392b"
                                : alert.type === "warning"
                                ? "#d68910"
                                : "#2471a3"
                            };">
                              ${
                                alert.type === "critical"
                                  ? "üî¥"
                                  : alert.type === "warning"
                                  ? "üü°"
                                  : "üîµ"
                              }
                              ${alert.title}
                            </strong>
                            <div style="font-size: 12px; color: #666; margin-top: 2px;">${
                              alert.company
                            }</div>
                          </div>
                          <span style="background: ${
                            alert.type === "critical"
                              ? "#e74c3c"
                              : alert.type === "warning"
                              ? "#f39c12"
                              : "#3498db"
                          }; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; text-transform: uppercase;">
                            ${alert.type}
                          </span>
                        </div>
                        <div style="color: #333; margin-bottom: 8px;">${
                          alert.message
                        }</div>
                        <div style="color: #666; font-size: 13px; font-style: italic;">
                          <strong>Recommended Action:</strong> ${alert.action}
                        </div>
                      </div>
                    `
                            )
                            .join("")
                    }
                  </div>
                `;
        } catch (error) {
          dashboardElement.innerHTML = `
                  <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <h3>Error Loading Alerts</h3>
                    <p>Failed to analyze financial data: ${error.message}</p>
                    <button onclick="loadDashboardData()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                      Retry
                    </button>
                  </div>
                `;
        }
      }

      function backToConnections() {
        if (
          confirm(
            "Return to connection manager? This will allow you to modify your company connections."
          )
        ) {
          document.getElementById("mainDashboard").style.display = "none";
          document.getElementById("connectionManager").style.display = "block";

          document.getElementById("step1").style.display = "block";
          document.getElementById("step2").style.display = "none";
          document.getElementById("step3").style.display = "none";

          document.getElementById("step1Indicator").className = "step active";
          document.getElementById("step2Indicator").className = "step";
          document.getElementById("step3Indicator").className = "step";

          loadSavedPreferences();
        }
      }

      // ====== INITIALIZATION ======

      async function initializePage() {
        handleOAuthReturn();

        if (localStorage.getItem("oauthCompanies")) {
          return;
        }

        try {
          const response = await fetch("/api/connection-status");
          const connections = await response.json();
          const connectedCount = connections.filter(
            (conn) => conn.connected
          ).length;

          if (connectedCount > 0) {
            document.getElementById("connectionManager").style.display = "none";
            document.getElementById("mainDashboard").style.display = "block";
            initializeMainDashboard();
          } else {
            document.getElementById("connectionManager").style.display =
              "block";
            document.getElementById("mainDashboard").style.display = "none";
            loadSavedPreferences();
          }
        } catch (error) {
          document.getElementById("connectionManager").style.display = "block";
          document.getElementById("mainDashboard").style.display = "none";
          loadSavedPreferences();
        }
      }

      // ====== EVENT LISTENERS ======

      document.addEventListener("DOMContentLoaded", function () {
        initializePage();
      });

      window.addEventListener("popstate", handleOAuthReturn);
    </script>
  </body>
</html>
